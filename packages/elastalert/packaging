set -ex

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
 # Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
export HOME=/var/vcap


PYTHON_PACKAGE_PATH=python
BOSH_PACKAGE_PATH=/var/vcap/packages
PYTHON_BIN_PATH=${BOSH_PACKAGE_PATH}/${PYTHON_PACKAGE_PATH}/bin
PYTHON_LIB_PATH=${BOSH_PACKAGE_PATH}/${PYTHON_PACKAGE_PATH}/lib/python
export PYTHONPATH=${PYTHON_LIB_PATH}
# Install venv for pip and friends
${PYTHON_BIN_PATH}/python3 -m venv ${BOSH_INSTALL_TARGET}/venv
. ${BOSH_INSTALL_TARGET}/venv/bin/activate


# install elastalert
pip3 install "elastalert==0.1.39"
# Have to pin dateutil to a verion < 2.7.0 for current version of elastalert
rm -rf ${BOSH_INSTALL_TARGET}/venv/lib/python3.7/site-packages/urllib3*
rm -rf ${BOSH_INSTALL_TARGET}/venv/lib/python3.7/site-packages/elasticsearch*
pip3 install "urllib3<1.25,>=1.21.1"
pip3 install "elasticsearch==5.5.3"
